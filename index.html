<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Braxdel Catering & Food Services â€“ Receipt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="index.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<header>
  <div class="header-left">
    <img src="images/BRAXDEL.png" alt="Braxdel Logo">
    <span>Braxdel Catering & Food Services</span>
  </div>

  <a href="history.html" class="nav-btn">
    <span>ðŸ“‹</span>
    <span>View History</span>
  </a>
</header>

<main>
<section class="card" id="formPage">
  <h2>Create Receipt</h2>

  <label>Date</label>
  <input type="date" id="date">

  <label>Customer</label>
  <input id="customer" placeholder="Enter customer name">

  <label>Receipt #</label>
  <input id="receiptNo" placeholder="Auto-generated" readonly style="background:#f5f5f5;cursor:not-allowed;">

  <h3>Items</h3>
  <div class="item-header row">
    <strong>Description</strong>
    <strong>Qty</strong>
    <strong>Price (NGN)</strong>
    <strong style="text-align:center;">Action</strong>
  </div>

  <div id="items"></div>

  <button class="btn-outline" type="button" onclick="addItem()">
    <span style="font-size:1.3em; line-height:1;">+</span>
    <span>Add Item</span>
  </button>

  <label>Payment Method</label>
  <select id="payment">
    <option>Bank Transfer</option>
    <option>POS</option>
    <option>Cash</option>
  </select>

  <button class="btn-primary" type="button" onclick="generateReceipt()">Generate & Save to Cloud</button>
</section>

<section class="card" id="receiptPage" style="display:none">
  <div id="receiptPreview">
    <div class="preview-header">
      <div>
        <h2>Braxdel Catering</h2>
        <small>& Food Services</small>
      </div>
      <img src="images/BRAXDEL.png" alt="Braxdel Logo">
    </div>

    <div class="preview-info">
      <div>
        <strong>Billed To</strong><br>
        <span id="pCustomer"></span>
      </div>
      <div>
        <strong>Date:</strong> <span id="pDate"></span><br>
        <strong>Receipt #:</strong> <span id="pRef"></span><br>
        <strong>Payment:</strong> <span id="pPay"></span>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Description</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="pItems"></tbody>
    </table>

    <div class="total">NGN <span id="pTotal"></span></div>

    <div class="footer">
      <div>
        Thank you for your patronage<br>
        <strong>Braxdel Catering & Food Services</strong>
      </div>
      <div id="pQR"></div>
    </div>
  </div>

  <div class="action-buttons">
    <button class="btn-secondary" onclick="printReceipt()">ðŸ–¨ Download PDF</button>
    <button class="btn-outline" onclick="location.reload()">â†» New Receipt</button>
  </div>
</section>
</main>

<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon">âœ“</div>
    <h3>Receipt Saved Successfully!</h3>
    <p>Data is now live in your Firebase Database.</p>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCfJoT1cXPjP-ua5Eo-2LOvoFr-389PXD0",
    authDomain: "braxdel-receips.firebaseapp.com",
    projectId: "braxdel-receips",
    storageBucket: "braxdel-receips.firebasestorage.app",
    messagingSenderId: "21198058228",
    appId: "1:21198058228:web:560818029764609c2364a1",
    measurementId: "G-M8YW9JY85E"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const itemsDiv = document.getElementById("items");
  const dateInput = document.getElementById("date");
  dateInput.valueAsDate = new Date();

  /* --- Add Item Row --- */
  window.addItem = function() {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input placeholder="Item description">
      <input type="number" min="1" placeholder="Qty">
      <input type="number" min="0" placeholder="Price">
      <button class="btn-danger" type="button" onclick="this.parentElement.remove()">Ã—</button>
    `;
    itemsDiv.appendChild(row);
  };
  addItem(); // Initial row

  /* --- Receipt Number --- */
  function generateID() {
    return `BRX-${Math.floor(Math.random()*900000+100000)}-${Math.floor(Math.random()*9000+1000)}`;
  }
  document.getElementById("receiptNo").value = generateID();

  /* --- Generate and Upload --- */
  window.generateReceipt = async function() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'Uploading to Firebase...';

    let total = 0;
    let itemsData = [];
    const pItems = document.getElementById("pItems");
    pItems.innerHTML = "";

    document.querySelectorAll("#items .row").forEach(row => {
      const [d, q, p] = row.querySelectorAll("input");
      if (!d.value) return;
      const qty = Number(q.value) || 1;
      const price = Number(p.value) || 0;
      const sum = qty * price;
      total += sum;
      itemsData.push({ d: d.value, q: qty, p: price, t: sum });

      pItems.insertAdjacentHTML("beforeend", `
        <tr><td>${d.value}</td><td>${qty}</td><td>NGN ${price.toLocaleString()}</td><td>NGN ${sum.toLocaleString()}</td></tr>
      `);
    });

    try {
      // UPLOAD TO FIRESTORE
      await addDoc(collection(db, "receipts"), {
        receiptNo: document.getElementById("receiptNo").value,
        customer: document.getElementById("customer").value || "Walk-in Customer",
        date: dateInput.value,
        payment: document.getElementById("payment").value,
        total: total,
        items: itemsData,
        createdAt: new Date().toISOString()
      });

      // Update Preview UI
      document.getElementById("pCustomer").textContent = document.getElementById("customer").value || "Customer";
      document.getElementById("pDate").textContent = dateInput.value;
      document.getElementById("pRef").textContent = document.getElementById("receiptNo").value;
      document.getElementById("pPay").textContent = document.getElementById("payment").value;
      document.getElementById("pTotal").textContent = total.toLocaleString();

      // QR Code
      const pQR = document.getElementById("pQR");
      pQR.innerHTML = "";
      new QRCode(pQR, {
        text: `https://luxury-lamington-0be902.netlify.app/verify.html?ref=${document.getElementById("receiptNo").value}`,
        width: 90, height: 90
      });

      document.getElementById("formPage").style.display = "none";
      document.getElementById("receiptPage").style.display = "block";
    } catch (e) {
      console.error(e);
      alert("Failed to save. Check internet connection.");
      btn.disabled = false;
      btn.innerHTML = "Generate & Save to Cloud";
    }
  };

  /* --- PDF Download --- */
  window.printReceipt = async function() {
    document.getElementById('successModal').style.display = 'block';
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");
    
    // Header
    const logo = await loadImage("images/BRAXDEL.png");
    if(logo) doc.addImage(logo, "PNG", 15, 15, 28, 28);
    doc.setFont("helvetica", "bold");
    doc.text("OFFICIAL RECEIPT", 105, 30, { align: "center" });

    // Table & Data (Simplified for this snippet, use your detailed PDF code here)
    doc.setFontSize(10);
    doc.text(`Customer: ${document.getElementById("pCustomer").textContent}`, 15, 50);
    doc.text(`Receipt #: ${document.getElementById("pRef").textContent}`, 15, 55);
    doc.text(`Total: NGN ${document.getElementById("pTotal").textContent}`, 15, 65);

    doc.save(`Braxdel_${document.getElementById("pRef").textContent}.pdf`);
  };

  function loadImage(src) {
    return new Promise(res => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = () => res(null);
      img.src = src;
    });
  }

  window.closeModal = () => document.getElementById('successModal').style.display = 'none';
</script>
</body>
</html>
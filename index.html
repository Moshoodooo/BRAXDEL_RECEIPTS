<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Braxdel Catering & Food Services â€“ Receipt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="index.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<header>
  <div class="header-left">
    <img src="images/BRAXDEL.png" alt="Braxdel Logo">
    <span>Braxdel Catering & Food Services</span>
  </div>

  <a href="history.html" class="nav-btn">
    <span>ðŸ“‹</span>
    <span>View History</span>
  </a>
</header>

<main>

<!-- ================= FORM PAGE ================= -->
<section class="card" id="formPage">
  <h2>Create Receipt</h2>

  <label>Date</label>
  <input type="date" id="date">

  <label>Customer</label>
  <input id="customer" placeholder="Enter customer name">

  <label>Receipt #</label>
  <input id="receiptNo" placeholder="Auto-generated" readonly style="background:#f5f5f5;cursor:not-allowed;">

  <h3>Items</h3>

  <!-- ITEM TABLE HEADER -->
  <div class="item-header row">
    <strong>Description</strong>
    <strong>Qty</strong>
    <strong>Price (NGN)</strong>
    <strong style="text-align:center;">Action</strong>
  </div>

  <!-- ITEM ROWS -->
  <div id="items"></div>

  <button class="btn-outline" type="button" onclick="addItem()">
    <span style="font-size:1.3em; line-height:1;">+</span>
    <span>Add Item</span>
  </button>

  <label>Payment Method</label>
  <select id="payment">
   
    <option>Bank Transfer</option>
    <option>POS</option>
    <option>Cash</option>
  </select>

  <button class="btn-primary" type="button" onclick="generateReceipt()">Generate Receipt</button>
</section>

<!-- ================= RECEIPT PAGE ================= -->
<section class="card" id="receiptPage" style="display:none">
  <div id="receiptPreview">

    <div class="preview-header">
      <div>
        <h2>Braxdel Catering</h2>
        <small>& Food Services</small>
      </div>
      <img src="images/BRAXDEL.png" alt="Braxdel Logo">
    </div>

    <div class="preview-info">
      <div>
        <strong>Billed To</strong><br>
        <span id="pCustomer"></span>
      </div>
      <div>
        <strong>Date:</strong> <span id="pDate"></span><br>
        <strong>Receipt #:</strong> <span id="pRef"></span><br>
        <strong>Payment:</strong> <span id="pPay"></span>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Description</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="pItems"></tbody>
    </table>

    <div class="total">NGN <span id="pTotal"></span></div>

    <div class="footer">
      <div>
        Thank you for your patronage<br>
        <strong>Braxdel Catering & Food Services</strong>
      </div>
      <div id="pQR"></div>
    </div>
  </div>

  <div class="action-buttons">
    <button class="btn-secondary" onclick="printReceipt()">ðŸ–¨ Print / Download PDF</button>
    <button class="btn-outline" onclick="location.reload()">â†» New Receipt</button>
  </div>
</section>

</main>

<!-- ================= SUCCESS MODAL ================= -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon">âœ“</div>
    <h3>Receipt Generated Successfully!</h3>
    <p>Your receipt has been created and is ready to download.</p>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
/* ================= DOM ================= */
const itemsDiv = document.getElementById("items");
const formPage = document.getElementById("formPage");
const receiptPage = document.getElementById("receiptPage");

const dateInput = document.getElementById("date");
const customerInput = document.getElementById("customer");
const receiptNoInput = document.getElementById("receiptNo");
const paymentSelect = document.getElementById("payment");

const pCustomer = document.getElementById("pCustomer");
const pDate = document.getElementById("pDate");
const pRef = document.getElementById("pRef");
const pPay = document.getElementById("pPay");
const pItems = document.getElementById("pItems");
const pTotal = document.getElementById("pTotal");
const pQR = document.getElementById("pQR");

dateInput.valueAsDate = new Date();

let receiptData = [];

/* ================= GENERATE SECURE RECEIPT NUMBER ================= */
function generateSecureReceiptNumber() {
  // Use crypto API for cryptographically secure random numbers
  if (window.crypto && window.crypto.getRandomValues) {
    const array = new Uint32Array(3);
    window.crypto.getRandomValues(array);
    
    // Generate format: BRX-XXXXXX-XXXX
    const part1 = (array[0] % 1000000).toString().padStart(6, '0');
    const part2 = (array[1] % 10000).toString().padStart(4, '0');
    
    return `BRX-${part1}-${part2}`;
  }
  
  // Fallback to Math.random with timestamp mixing for additional entropy
  const timestamp = Date.now();
  const random1 = Math.floor(Math.random() * 1000000);
  const random2 = Math.floor(Math.random() * 10000);
  const mixed1 = ((timestamp * random1) % 1000000).toString().padStart(6, '0');
  const mixed2 = ((timestamp * random2) % 10000).toString().padStart(4, '0');
  
  return `BRX-${mixed1}-${mixed2}`;
}

/* ================= CHECK FOR DUPLICATE RECEIPT NUMBER ================= */
function isReceiptNumberUnique(receiptNo) {
  const history = JSON.parse(localStorage.getItem("receipts") || "[]");
  return !history.some(r => r.receiptNo === receiptNo);
}

/* ================= GENERATE UNIQUE RECEIPT NUMBER ================= */
function generateUniqueReceiptNumber() {
  let receiptNo;
  let attempts = 0;
  const maxAttempts = 10;
  
  do {
    receiptNo = generateSecureReceiptNumber();
    attempts++;
  } while (!isReceiptNumberUnique(receiptNo) && attempts < maxAttempts);
  
  return receiptNo;
}

// Generate receipt number on page load
receiptNoInput.value = generateUniqueReceiptNumber();

/* ================= ADD ITEM ================= */
function addItem() {
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `
    <input placeholder="Item description">
    <input type="number" min="1" placeholder="Qty">
    <input type="number" min="0" placeholder="Price">
    <button class="btn-danger" type="button" onclick="this.parentElement.remove()">Ã—</button>
  `;
  itemsDiv.appendChild(row);
}

addItem();

/* ================= GENERATE RECEIPT WITH LOADING ================= */
function generateReceipt() {
  const btn = event.target;
  const originalText = btn.innerHTML;
  
  // Show loading state
  btn.disabled = true;
  btn.innerHTML = 'Generating<span class="loader"></span>';
  
  // Simulate 3 second loading
  setTimeout(() => {
    let total = 0;
    receiptData = [];
    pItems.innerHTML = "";

    document.querySelectorAll("#items .row").forEach(row => {
      const [d, q, p] = row.querySelectorAll("input");
      if (!d.value) return;

      const qty = Number(q.value) || 1; // Default to 1 if empty
      const price = Number(p.value) || 0;
      const sum = qty * price;

      total += sum;
      receiptData.push({ d: d.value, q: qty, p: price, t: sum });

      pItems.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${d.value}</td>
          <td>${qty}</td>
          <td>NGN ${price.toLocaleString()}</td>
          <td>NGN ${sum.toLocaleString()}</td>
        </tr>
      `);
    });

    pCustomer.textContent = customerInput.value || "Customer";
    pDate.textContent = dateInput.value;
    pRef.textContent = receiptNoInput.value;
    pPay.textContent = paymentSelect.value || "-";
    pTotal.textContent = total.toLocaleString();

    pQR.innerHTML = "";
    new QRCode(pQR, {
      text: `https://luxury-lamington-0be902.netlify.app/verify.html?ref=${receiptNoInput.value}`,
      width: 90,
      height: 90
    });

    /* ===== SAVE TO LOCAL STORAGE FOR HISTORY ===== */
    const history = JSON.parse(localStorage.getItem("receipts") || "[]");
    history.push({
      receiptNo: receiptNoInput.value,
      customer: customerInput.value || "Customer",
      date: dateInput.value,
      payment: paymentSelect.value || "-",
      total,
      items: receiptData,
      createdAt: new Date().toISOString()
    });
    localStorage.setItem("receipts", JSON.stringify(history));

    // Reset button and show receipt
    btn.disabled = false;
    btn.innerHTML = originalText;
    formPage.style.display = "none";
    receiptPage.style.display = "block";
  }, 3000);
}

/* ================= PRINT / DOWNLOAD PDF WITH MODAL ================= */
async function printReceipt() {
  const modal = document.getElementById('successModal');
  modal.style.display = 'block';
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const margin = 15;
  const pageWidth = 210;
  let y = margin;

  // Load logo
  const logo = await loadImage("images/BRAXDEL.png");
  doc.addImage(logo, "PNG", margin, y, 28, 28);

  // Header text
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("Receipt", 105, y + 12, { align: "center" });
  doc.setFontSize(12);
  

  y += 40;

  // Border line
  doc.setDrawColor(255, 107, 53);
  doc.setLineWidth(0.8);
  doc.line(margin, y, pageWidth - margin, y);
  y += 12;

  // Billed To & Info
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Billed To", margin, y);
  doc.setFont("helvetica", "normal");
  
  // Handle long customer names with text wrapping
  const customerName = pCustomer.textContent;
  const maxWidth = 80; // Maximum width for customer name
  const lines = doc.splitTextToSize(customerName, maxWidth);
  
  lines.forEach((line, index) => {
    doc.text(line, margin, y + 6 + (index * 5));
  });
  
  // Adjust y position based on number of lines
  const extraHeight = (lines.length - 1) * 5;

  doc.setFont("helvetica", "bold");
  doc.text("Date:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(pDate.textContent, 145, y);

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Receipt #:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(pRef.textContent, 145, y);

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Payment:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(pPay.textContent, 145, y);

  y += 18 + extraHeight;

  // Table Header
  const tableWidth = pageWidth - (2 * margin);
  doc.setFillColor(0, 30, 64);
  doc.rect(margin, y, tableWidth, 10, "F");
  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(10);
  doc.text("Description", margin + 3, y + 7);
  doc.text("Qty", 110, y + 7, { align: "center" });
  doc.text("Price", 145, y + 7, { align: "right" });
  doc.text("Total", pageWidth - margin - 3, y + 7, { align: "right" });

  y += 12;

  // Table rows
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  
  receiptData.forEach((item, index) => {
    if (index % 2 === 0) {
      doc.setFillColor(248, 248, 248);
      doc.rect(margin, y - 1, tableWidth, 8, "F");
    }
    
    doc.setTextColor(0);
    doc.text(item.d, margin + 3, y + 5);
    doc.text(item.q.toString(), 110, y + 5, { align: "center" });
    doc.text(`NGN ${Number(item.p).toLocaleString()}`, 145, y + 5, { align: "right" });
    doc.text(`NGN ${item.t.toLocaleString()}`, pageWidth - margin - 3, y + 5, { align: "right" });
    
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.2);
    doc.line(margin, y + 7, pageWidth - margin, y + 7);
    
    y += 8;
  });

  y += 5;

  // Dashed line before total
  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.5);
  doc.setLineDash([3, 3]);
  doc.line(margin, y, pageWidth - margin, y);
  doc.setLineDash([]);

  y += 12;

  // Total
  doc.setFontSize(16);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(255, 107, 53);
  doc.text(`Total: NGN ${pTotal.textContent}`, pageWidth - margin - 3, y, { align: "right" });

  y += 25;

  // Footer dashed line
  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.5);
  doc.setLineDash([3, 3]);
  doc.line(margin, y, pageWidth - margin, y);
  doc.setLineDash([]);

  y += 10;

  // Footer text
  doc.setFontSize(9);
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  doc.text("Thank you for your patronage", margin, y);
  doc.setFont("helvetica", "bold");
  doc.text("Braxdel Catering & Food Services", margin, y + 5);

  // QR Code in PDF
  const qrCanvas = pQR.querySelector("canvas");
  if (qrCanvas) {
    const qrImage = qrCanvas.toDataURL("image/png");
    doc.addImage(qrImage, "PNG", pageWidth - margin - 28, y - 8, 25, 25);
  }

  // Save PDF
  doc.save(`Braxdel_${pRef.textContent}.pdf`);
}

/* ===== CLOSE MODAL ===== */
function closeModal() {
  document.getElementById('successModal').style.display = 'none';
}

/* ===== LOAD IMAGE HELPER ===== */
function loadImage(src) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => res(img);
    img.src = src;
  });
}
</script>

</body>
</html>
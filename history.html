<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Braxdel ‚Äì Receipt History</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="index.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
.action-cell {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.btn-download {
  background: var(--primary);
  color: #fff;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.3s;
}

.btn-delete {
  background: #ffecec;
  color: #c0392b;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.3s;
}

.btn-download:hover {
  background: #e55d2f;
}

.btn-delete:hover {
  background: #ffdddd;
}

.empty {
  text-align: center;
  padding: 40px;
  color: #777;
  font-size: 1rem;
}

/* Mobile Card View */
.receipt-card {
  display: none;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid #e0e0e0;
}

.receipt-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid #ddd;
}

.receipt-card-number {
  font-weight: 700;
  color: var(--primary);
  font-size: 0.95rem;
}

.receipt-card-date {
  color: #666;
  font-size: 0.8rem;
}

.receipt-card-details {
  margin-bottom: 12px;
}

.receipt-card-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  font-size: 0.85rem;
}

.receipt-card-label {
  color: #666;
  font-weight: 500;
}

.receipt-card-value {
  color: var(--secondary);
  font-weight: 600;
}

.receipt-card-total {
  color: var(--primary);
  font-weight: 700;
  font-size: 1.1rem;
}

.receipt-card-actions {
  display: flex;
  gap: 8px;
}

.receipt-card-actions button {
  flex: 1;
  padding: 10px;
  font-size: 0.85rem;
}

/* Tablet responsiveness */
@media (max-width: 1024px) {
  table {
    font-size: 0.85rem;
  }
  
  th, td {
    padding: 10px 8px;
  }
  
  .btn-download, .btn-delete {
    padding: 7px 12px;
    font-size: 0.8rem;
  }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  #historyTable {
    display: none !important;
  }
  
  .receipt-card {
    display: block;
  }
  
  .action-cell {
    flex-direction: column;
    gap: 6px;
  }
  
  .btn-download, .btn-delete {
    width: 100%;
    padding: 10px;
    font-size: 0.85rem;
  }
  
  .empty {
    padding: 60px 20px;
    font-size: 0.95rem;
  }
}

@media (max-width: 480px) {
  .receipt-card {
    padding: 14px;
    margin-bottom: 10px;
  }
  
  .receipt-card-number {
    font-size: 0.9rem;
  }
  
  .receipt-card-date {
    font-size: 0.75rem;
  }
  
  .receipt-card-row {
    font-size: 0.8rem;
  }
  
  .receipt-card-total {
    font-size: 1rem;
  }
  
  .receipt-card-actions button {
    padding: 9px;
    font-size: 0.8rem;
  }
  
  .empty {
    padding: 50px 15px;
    font-size: 0.9rem;
  }
}
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="images/BRAXDEL.png" alt="Braxdel Logo">
    <span>Receipt</span>
  </div>
  <a href="index.html" class="nav-btn">
    <span>‚Üê</span>
    <span>Back</span>
  </a>
</header>

<main>
  <section class="card">
    <h2>Receipt History</h2>

    <!-- Desktop/Tablet Table View -->
    <table id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Receipt #</th>
          <th>Customer</th>
          <th>Total</th>
          <th style="text-align:right">Actions</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>

    <!-- Mobile Card View -->
    <div id="mobileCards"></div>

    <div id="emptyState" class="empty" style="display:none">
      No receipts found.
    </div>
  </section>
</main>

<!-- Success Modal -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon">‚úì</div>
    <h3>Receipt Downloaded Successfully!</h3>
    <p>Your receipt PDF has been generated and downloaded.</p>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon" style="background:#c0392b;">‚ö†</div>
    <h3>Delete Receipt?</h3>
    <p>Are you sure you want to delete this receipt? This action cannot be undone.</p>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button class="modal-close" onclick="closeDeleteModal()">Cancel</button>
      <button class="modal-close" style="background:#c0392b;" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
const historyBody = document.getElementById("historyBody");
const mobileCards = document.getElementById("mobileCards");
const emptyState = document.getElementById("emptyState");
const historyTable = document.getElementById("historyTable");
let deleteIndex = -1;

/* ===== GENERATE SECURE RECEIPT NUMBER ===== */
function generateSecureReceiptNumber() {
  // Use crypto API for cryptographically secure random numbers
  if (window.crypto && window.crypto.getRandomValues) {
    const array = new Uint32Array(3);
    window.crypto.getRandomValues(array);
    
    // Generate format: BRX-XXXXXX-XXXX
    const part1 = (array[0] % 1000000).toString().padStart(6, '0');
    const part2 = (array[1] % 10000).toString().padStart(4, '0');
    
    return `BRX-${part1}-${part2}`;
  }
  
  // Fallback to Math.random with timestamp mixing
  const timestamp = Date.now();
  const random1 = Math.floor(Math.random() * 1000000);
  const random2 = Math.floor(Math.random() * 10000);
  const mixed1 = ((timestamp * random1) % 1000000).toString().padStart(6, '0');
  const mixed2 = ((timestamp * random2) % 10000).toString().padStart(4, '0');
  
  return `BRX-${mixed1}-${mixed2}`;
}

/* ===== LOAD RECEIPTS ===== */
function loadHistory() {
  historyBody.innerHTML = "";
  mobileCards.innerHTML = "";
  const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");

  receipts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

  if (!receipts.length) {
    emptyState.style.display = "block";
    historyTable.style.display = "none";
    mobileCards.style.display = "none";
    return;
  }

  emptyState.style.display = "none";
  historyTable.style.display = "table";
  mobileCards.style.display = "block";

  receipts.forEach((r, index) => {
    // Desktop table row
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(r.createdAt).toLocaleDateString()}</td>
      <td>${r.receiptNo}</td>
      <td>${r.customer}</td>
      <td>NGN ${Number(r.total).toLocaleString()}</td>
      <td>
        <div class="action-cell">
          <button class="btn-download" onclick='downloadPDF(${index})'>
            üì• Download
          </button>
          <button class="btn-delete" onclick='deleteReceipt(${index})'>
            üóë Delete
          </button>
        </div>
      </td>
    `;
    historyBody.appendChild(tr);

    // Mobile card
    const card = document.createElement("div");
    card.className = "receipt-card";
    card.innerHTML = `
      <div class="receipt-card-header">
        <div class="receipt-card-number">${r.receiptNo}</div>
        <div class="receipt-card-date">${new Date(r.createdAt).toLocaleDateString()}</div>
      </div>
      <div class="receipt-card-details">
        <div class="receipt-card-row">
          <span class="receipt-card-label">Customer:</span>
          <span class="receipt-card-value">${r.customer}</span>
        </div>
        <div class="receipt-card-row">
          <span class="receipt-card-label">Total:</span>
          <span class="receipt-card-total">NGN ${Number(r.total).toLocaleString()}</span>
        </div>
      </div>
      <div class="receipt-card-actions">
        <button class="btn-download" onclick='downloadPDF(${index})'>
          üì• Download
        </button>
        <button class="btn-delete" onclick='deleteReceipt(${index})'>
          üóë Delete
        </button>
      </div>
    `;
    mobileCards.appendChild(card);
  });
}

/* ===== DELETE RECEIPT ===== */
function deleteReceipt(index) {
  deleteIndex = index;
  document.getElementById('deleteModal').style.display = 'block';
}

function confirmDelete() {
  const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");
  receipts.splice(deleteIndex, 1);
  localStorage.setItem("receipts", JSON.stringify(receipts));
  closeDeleteModal();
  loadHistory();
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  deleteIndex = -1;
}

/* ===== DOWNLOAD PDF WITH EXACT SAME FORMAT AS INDEX.HTML ===== */
async function downloadPDF(index) {
  const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");
  const receipt = receipts[index];
  
  // Show success modal
  document.getElementById('successModal').style.display = 'block';
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const margin = 15;
  const pageWidth = 210;
  let y = margin;

  // Load logo
  const logo = await loadImage("images/BRAXDEL.png");
  doc.addImage(logo, "PNG", margin, y, 28, 28);

  // Header text
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("Receipt", 105, y + 12, { align: "center" });
  doc.setFontSize(12);
 

  y += 40;

  // Border line
  doc.setDrawColor(255, 107, 53);
  doc.setLineWidth(0.8);
  doc.line(margin, y, pageWidth - margin, y);
  y += 12;

  // Billed To & Info
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Billed To", margin, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.customer, margin, y + 6);

  doc.setFont("helvetica", "bold");
  doc.text("Date:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.date || new Date(receipt.createdAt).toLocaleDateString(), 145, y);

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Receipt #:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.receiptNo, 145, y);

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Payment:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.payment || "-", 145, y);

  y += 18;

  // Table Header
  const tableWidth = pageWidth - (2 * margin);
  doc.setFillColor(0, 30, 64);
  doc.rect(margin, y, tableWidth, 10, "F");
  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(10);
  doc.text("Description", margin + 3, y + 7);
  doc.text("Qty", 110, y + 7, { align: "center" });
  doc.text("Price", 145, y + 7, { align: "right" });
  doc.text("Total", pageWidth - margin - 3, y + 7, { align: "right" });

  y += 12;

  // Table rows
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  
  receipt.items.forEach((item, idx) => {
    if (idx % 2 === 0) {
      doc.setFillColor(248, 248, 248);
      doc.rect(margin, y - 1, tableWidth, 8, "F");
    }
    
    doc.setTextColor(0);
    doc.text(item.d, margin + 3, y + 5);
    doc.text(item.q.toString(), 110, y + 5, { align: "center" });
    doc.text(`NGN ${Number(item.p).toLocaleString()}`, 145, y + 5, { align: "right" });
    doc.text(`NGN ${item.t.toLocaleString()}`, pageWidth - margin - 3, y + 5, { align: "right" });
    
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.2);
    doc.line(margin, y + 7, pageWidth - margin, y + 7);
    
    y += 8;
  });

  y += 5;

  // Dashed line before total
  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.5);
  doc.setLineDash([3, 3]);
  doc.line(margin, y, pageWidth - margin, y);
  doc.setLineDash([]);

  y += 12;

  // Total
  doc.setFontSize(16);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(255, 107, 53);
  doc.text(`Total: NGN ${Number(receipt.total).toLocaleString()}`, pageWidth - margin - 3, y, { align: "right" });

  y += 25;

  // Footer dashed line
  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.5);
  doc.setLineDash([3, 3]);
  doc.line(margin, y, pageWidth - margin, y);
  doc.setLineDash([]);

  y += 10;

  // Footer text
  doc.setFontSize(9);
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  doc.text("Thank you for your patronage", margin, y);
  doc.setFont("helvetica", "bold");
  doc.text("Braxdel Catering & Food Services", margin, y + 5);

  // Generate QR Code and add to PDF
  const tempDiv = document.createElement('div');
  tempDiv.style.display = 'none';
  document.body.appendChild(tempDiv);
  
  const qr = new QRCode(tempDiv, {
    text: `https://luxury-lamington-0be902.netlify.app/verify.html?ref=${receipt.receiptNo}`,
    width: 90,
    height: 90
  });
  
  // Wait for QR code to generate
  setTimeout(() => {
    const qrCanvas = tempDiv.querySelector("canvas");
    if (qrCanvas) {
      const qrImage = qrCanvas.toDataURL("image/png");
      doc.addImage(qrImage, "PNG", pageWidth - margin - 28, y - 8, 25, 25);
    }
    
    // Clean up and save
    document.body.removeChild(tempDiv);
    doc.save(`Braxdel_${receipt.receiptNo}.pdf`);
  }, 100);
}

/* ===== CLOSE MODAL ===== */
function closeModal() {
  document.getElementById('successModal').style.display = 'none';
}

/* ===== LOAD IMAGE HELPER ===== */
function loadImage(src) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => res(img);
    img.src = src;
  });
}

loadHistory();
</script>

</body>
</html>
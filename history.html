<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Braxdel ‚Äì Receipt History</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="index.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
.action-cell {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.btn-download {
  background: var(--primary);
  color: #fff;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
}

.btn-delete {
  background: #ffecec;
  color: #c0392b;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
}

.btn-download:hover {
  background: #e55d2f;
}

.btn-delete:hover {
  background: #ffdddd;
}

.empty {
  text-align: center;
  padding: 40px;
  color: #777;
}

@media (max-width: 768px) {
  .action-cell {
    flex-direction: column;
    gap: 4px;
  }
  
  .btn-download, .btn-delete {
    width: 100%;
  }
}
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="images/BRAXDEL.png" alt="Braxdel Logo">
    <span>Receipt</span>
  </div>
  <a href="index.html" class="nav-btn">
    <span>‚Üê</span>
    <span>Back</span>
  </a>
</header>

<main>
  <section class="card">
    <h2>Receipt History</h2>

    <table id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Receipt #</th>
          <th>Customer</th>
          <th>Total</th>
          <th style="text-align:right">Actions</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>

    <div id="emptyState" class="empty" style="display:none">
      No receipts found.
    </div>
  </section>
</main>

<!-- Success Modal -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon">‚úì</div>
    <h3>Receipt Downloaded Successfully!</h3>
    <p>Your receipt PDF has been generated and downloaded.</p>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon" style="background:#c0392b;">‚ö†</div>
    <h3>Delete Receipt?</h3>
    <p>Are you sure you want to delete this receipt? This action cannot be undone.</p>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button class="modal-close" onclick="closeDeleteModal()">Cancel</button>
      <button class="modal-close" style="background:#c0392b;" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
const historyBody = document.getElementById("historyBody");
const emptyState = document.getElementById("emptyState");
const historyTable = document.getElementById("historyTable");
let deleteIndex = -1;

/* ===== LOAD RECEIPTS ===== */
function loadHistory() {
  historyBody.innerHTML = "";
  const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");

  receipts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

  if (!receipts.length) {
    emptyState.style.display = "block";
    historyTable.style.display = "none";
    return;
  }

  emptyState.style.display = "none";
  historyTable.style.display = "table";

  receipts.forEach((r, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(r.createdAt).toLocaleDateString()}</td>
      <td>${r.receiptNo}</td>
      <td>${r.customer}</td>
      <td>NGN ${Number(r.total).toLocaleString()}</td>
      <td>
        <div class="action-cell">
          <button class="btn-download" onclick='downloadPDF(${index})'>
            üì• Download
          </button>
          <button class="btn-delete" onclick='deleteReceipt(${index})'>
            üóë Delete
          </button>
        </div>
      </td>
    `;
    historyBody.appendChild(tr);
  });
}

/* ===== DELETE RECEIPT ===== */
function deleteReceipt(index) {
  deleteIndex = index;
  document.getElementById('deleteModal').style.display = 'block';
}

function confirmDelete() {
  const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");
  receipts.splice(deleteIndex, 1);
  localStorage.setItem("receipts", JSON.stringify(receipts));
  closeDeleteModal();
  loadHistory();
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  deleteIndex = -1;
}

/* ===== DOWNLOAD PDF WITH EXACT SAME FORMAT AS INDEX.HTML ===== */
async function downloadPDF(index) {
  const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");
  const receipt = receipts[index];
  
  // Show success modal
  document.getElementById('successModal').style.display = 'block';
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const margin = 15;
  const pageWidth = 210;
  let y = margin;

  // Load logo
  const logo = await loadImage("images/BRAXDEL.png");
  doc.addImage(logo, "PNG", margin, y, 28, 28);

  // Header text
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("Receipt", 105, y + 12, { align: "center" });
  doc.setFontSize(12);
 

  y += 40;

  // Border line
  doc.setDrawColor(255, 107, 53);
  doc.setLineWidth(0.8);
  doc.line(margin, y, pageWidth - margin, y);
  y += 12;

  // Billed To & Info
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Billed To", margin, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.customer, margin, y + 6);

  doc.setFont("helvetica", "bold");
  doc.text("Date:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.date || new Date(receipt.createdAt).toLocaleDateString(), 145, y);

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Receipt #:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.receiptNo, 145, y);

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Payment:", 120, y);
  doc.setFont("helvetica", "normal");
  doc.text(receipt.payment || "-", 145, y);

  y += 18;

  // Table Header
  const tableWidth = pageWidth - (2 * margin);
  doc.setFillColor(0, 30, 64);
  doc.rect(margin, y, tableWidth, 10, "F");
  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(10);
  doc.text("Description", margin + 3, y + 7);
  doc.text("Qty", 110, y + 7, { align: "center" });
  doc.text("Price", 145, y + 7, { align: "right" });
  doc.text("Total", pageWidth - margin - 3, y + 7, { align: "right" });

  y += 12;

  // Table rows
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  
  receipt.items.forEach((item, idx) => {
    if (idx % 2 === 0) {
      doc.setFillColor(248, 248, 248);
      doc.rect(margin, y - 1, tableWidth, 8, "F");
    }
    
    doc.setTextColor(0);
    doc.text(item.d, margin + 3, y + 5);
    doc.text(item.q.toString(), 110, y + 5, { align: "center" });
    doc.text(`NGN ${Number(item.p).toLocaleString()}`, 145, y + 5, { align: "right" });
    doc.text(`NGN ${item.t.toLocaleString()}`, pageWidth - margin - 3, y + 5, { align: "right" });
    
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.2);
    doc.line(margin, y + 7, pageWidth - margin, y + 7);
    
    y += 8;
  });

  y += 5;

  // Dashed line before total
  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.5);
  doc.setLineDash([3, 3]);
  doc.line(margin, y, pageWidth - margin, y);
  doc.setLineDash([]);

  y += 12;

  // Total
  doc.setFontSize(16);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(255, 107, 53);
  doc.text(`Total: NGN ${Number(receipt.total).toLocaleString()}`, pageWidth - margin - 3, y, { align: "right" });

  y += 25;

  // Footer dashed line
  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.5);
  doc.setLineDash([3, 3]);
  doc.line(margin, y, pageWidth - margin, y);
  doc.setLineDash([]);

  y += 10;

  // Footer text
  doc.setFontSize(9);
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  doc.text("Thank you for your patronage", margin, y);
  doc.setFont("helvetica", "bold");
  doc.text("Braxdel Catering & Food Services", margin, y + 5);

  // Generate QR Code and add to PDF
  const tempDiv = document.createElement('div');
  tempDiv.style.display = 'none';
  document.body.appendChild(tempDiv);
  
  const qr = new QRCode(tempDiv, {
    text: `https://braxdel.com/verify.html?ref=${receipt.receiptNo}`,
    width: 90,
    height: 90
  });
  
  // Wait for QR code to generate
  setTimeout(() => {
    const qrCanvas = tempDiv.querySelector("canvas");
    if (qrCanvas) {
      const qrImage = qrCanvas.toDataURL("image/png");
      doc.addImage(qrImage, "PNG", pageWidth - margin - 28, y - 8, 25, 25);
    }
    
    // Clean up and save
    document.body.removeChild(tempDiv);
    doc.save(`Braxdel_${receipt.receiptNo}.pdf`);
  }, 100);
}

/* ===== CLOSE MODAL ===== */
function closeModal() {
  document.getElementById('successModal').style.display = 'none';
}

/* ===== LOAD IMAGE HELPER ===== */
function loadImage(src) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => res(img);
    img.src = src;
  });
}

loadHistory();
</script>

</body>
</html>
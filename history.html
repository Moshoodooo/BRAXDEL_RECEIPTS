<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Braxdel ‚Äì Receipt History</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="index.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
/* ... (Your existing CSS remains identical) ... */
.action-cell { display: flex; gap: 8px; justify-content: flex-end; }
.btn-download { background: var(--primary); color: #fff; padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
.btn-delete { background: #ffecec; color: #c0392b; padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
.btn-download:hover { background: #e55d2f; }
.btn-delete:hover { background: #ffdddd; }
.empty { text-align: center; padding: 40px; color: #777; font-size: 1rem; }
.receipt-card { display: none; background: #f8f9fa; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #e0e0e0; }
.receipt-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #ddd; }
.receipt-card-number { font-weight: 700; color: var(--primary); font-size: 0.95rem; }
.receipt-card-date { color: #666; font-size: 0.8rem; }
.receipt-card-details { margin-bottom: 12px; }
.receipt-card-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.85rem; }
.receipt-card-label { color: #666; font-weight: 500; }
.receipt-card-value { color: var(--secondary); font-weight: 600; }
.receipt-card-total { color: var(--primary); font-weight: 700; font-size: 1.1rem; }
.receipt-card-actions { display: flex; gap: 8px; }
.receipt-card-actions button { flex: 1; padding: 10px; font-size: 0.85rem; }
@media (max-width: 768px) { #historyTable { display: none !important; } .receipt-card { display: block; } .action-cell { flex-direction: column; gap: 6px; } .btn-download, .btn-delete { width: 100%; padding: 10px; font-size: 0.85rem; } .empty { padding: 60px 20px; font-size: 0.95rem; } }
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="images/BRAXDEL.png" alt="Braxdel Logo">
    <span>Receipt</span>
  </div>
  <a href="index.html" class="nav-btn">
    <span>‚Üê</span>
    <span>Back</span>
  </a>
</header>

<main>
  <section class="card">
    <h2>Receipt History</h2>

    <table id="historyTable" style="display:none">
      <thead>
        <tr>
          <th>Date</th>
          <th>Receipt #</th>
          <th>Customer</th>
          <th>Total</th>
          <th style="text-align:right">Actions</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>

    <div id="mobileCards"></div>

    <div id="emptyState" class="empty" style="display:none">
      No receipts found in the database.
    </div>
  </section>
</main>

<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon">‚úì</div>
    <h3>Receipt Downloaded!</h3>
    <button class="modal-close" onclick="document.getElementById('successModal').style.display='none'">Close</button>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-icon" style="background:#c0392b;">‚ö†</div>
    <h3>Delete Receipt?</h3>
    <p>This action will permanently remove the record from Firebase.</p>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button class="modal-close" onclick="closeDeleteModal()">Cancel</button>
      <button class="modal-close" style="background:#c0392b;" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getFirestore, collection, getDocs, doc, deleteDoc, query, orderBy, getDoc 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 1. Firebase Configuration (Your specific credentials)
  const firebaseConfig = {
    apiKey: "AIzaSyCfJoT1cXPjP-ua5Eo-2LOvoFr-389PXD0",
    authDomain: "braxdel-receips.firebaseapp.com",
    projectId: "braxdel-receips",
    storageBucket: "braxdel-receips.firebasestorage.app",
    messagingSenderId: "21198058228",
    appId: "1:21198058228:web:560818029764609c2364a1",
    measurementId: "G-M8YW9JY85E"
  };

  // 2. Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const historyBody = document.getElementById("historyBody");
  const mobileCards = document.getElementById("mobileCards");
  const emptyState = document.getElementById("emptyState");
  const historyTable = document.getElementById("historyTable");
  let currentDeleteId = null;

  /* ===== LOAD HISTORY FROM FIRESTORE ===== */
  async function loadHistory() {
    historyBody.innerHTML = "";
    mobileCards.innerHTML = "";
    
    try {
      // Pulling from collection 'receipts'
      const q = query(collection(db, "receipts"), orderBy("createdAt", "desc"));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        emptyState.style.display = "block";
        historyTable.style.display = "none";
        return;
      }

      emptyState.style.display = "none";
      historyTable.style.display = "table";

      querySnapshot.forEach((docSnap) => {
        const r = docSnap.data();
        const id = docSnap.id;
        const dateStr = r.createdAt ? new Date(r.createdAt).toLocaleDateString() : 'N/A';

        // Table Row (Desktop)
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dateStr}</td>
          <td>${r.receiptNo}</td>
          <td>${r.customer}</td>
          <td>NGN ${Number(r.total).toLocaleString()}</td>
          <td>
            <div class="action-cell">
              <button class="btn-download" data-id="${id}">üì• Download</button>
              <button class="btn-delete" data-id="${id}">üóë Delete</button>
            </div>
          </td>
        `;
        historyBody.appendChild(tr);

        // Mobile Card
        const card = document.createElement("div");
        card.className = "receipt-card";
        card.innerHTML = `
          <div class="receipt-card-header">
            <div class="receipt-card-number">${r.receiptNo}</div>
            <div class="receipt-card-date">${dateStr}</div>
          </div>
          <div class="receipt-card-details">
            <div class="receipt-card-row">
              <span class="receipt-card-label">Customer:</span>
              <span class="receipt-card-value">${r.customer}</span>
            </div>
            <div class="receipt-card-row">
              <span class="receipt-card-label">Total:</span>
              <span class="receipt-card-total">NGN ${Number(r.total).toLocaleString()}</span>
            </div>
          </div>
          <div class="receipt-card-actions">
            <button class="btn-download" data-id="${id}">üì• Download</button>
            <button class="btn-delete" data-id="${id}">üóë Delete</button>
          </div>
        `;
        mobileCards.appendChild(card);
      });

      attachButtonListeners();
    } catch (error) {
      console.error("Error fetching from Firestore:", error);
    }
  }

  /* ===== BUTTON CLICK HANDLERS ===== */
  function attachButtonListeners() {
    document.querySelectorAll('.btn-download').forEach(btn => {
      btn.onclick = () => downloadPDF(btn.getAttribute('data-id'));
    });
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.onclick = () => {
        currentDeleteId = btn.getAttribute('data-id');
        document.getElementById('deleteModal').style.display = 'block';
      };
    });
  }

  // Close Delete Modal
  window.closeDeleteModal = () => {
    document.getElementById('deleteModal').style.display = 'none';
    currentDeleteId = null;
  };

  // Confirm Delete in Firebase
  document.getElementById('confirmDeleteBtn').onclick = async () => {
    if (currentDeleteId) {
      await deleteDoc(doc(db, "receipts", currentDeleteId));
      window.closeDeleteModal();
      loadHistory();
    }
  };

  /* ===== DOWNLOAD PDF (Fetch specific doc from DB) ===== */
  async function downloadPDF(id) {
    const docSnap = await getDoc(doc(db, "receipts", id));
    if (!docSnap.exists()) return;
    const receipt = docSnap.data();

    document.getElementById('successModal').style.display = 'block';
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    const margin = 15;
    const pageWidth = 210;
    let y = margin;

    const logo = await loadImage("images/BRAXDEL.png");
    if (logo) pdf.addImage(logo, "PNG", margin, y, 28, 28);

    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(18);
    pdf.text("Receipt", 105, y + 12, { align: "center" });

    y += 40;
    pdf.setDrawColor(255, 107, 53);
    pdf.setLineWidth(0.8);
    pdf.line(margin, y, pageWidth - margin, y);
    y += 12;

    pdf.setFontSize(11);
    pdf.text("Billed To", margin, y);
    pdf.setFont("helvetica", "normal");
    pdf.text(receipt.customer, margin, y + 6);

    pdf.setFont("helvetica", "bold");
    pdf.text("Date:", 120, y);
    pdf.setFont("helvetica", "normal");
    pdf.text(new Date(receipt.createdAt).toLocaleDateString(), 145, y);

    y += 8;
    pdf.setFont("helvetica", "bold");
    pdf.text("Receipt #:", 120, y);
    pdf.setFont("helvetica", "normal");
    pdf.text(receipt.receiptNo, 145, y);

    y += 18;
    // Table Header
    pdf.setFillColor(0, 30, 64);
    pdf.rect(margin, y, pageWidth - (2 * margin), 10, "F");
    pdf.setTextColor(255);
    pdf.text("Description", margin + 3, y + 7);
    pdf.text("Total", pageWidth - margin - 3, y + 7, { align: "right" });

    y += 12;
    pdf.setTextColor(0);
    receipt.items.forEach((item) => {
      pdf.text(item.d, margin + 3, y + 5);
      pdf.text(`NGN ${item.t.toLocaleString()}`, pageWidth - margin - 3, y + 5, { align: "right" });
      y += 8;
    });

    y += 10;
    pdf.setFontSize(16);
    pdf.setTextColor(255, 107, 53);
    pdf.text(`Total: NGN ${Number(receipt.total).toLocaleString()}`, pageWidth - margin - 3, y, { align: "right" });

    // QR Code
    const tempDiv = document.createElement('div');
    new QRCode(tempDiv, {
      text: `https://luxury-lamington-0be902.netlify.app/verify.html?ref=${receipt.receiptNo}`,
      width: 90, height: 90
    });

    setTimeout(() => {
      const qrCanvas = tempDiv.querySelector("canvas");
      if (qrCanvas) {
        const qrImage = qrCanvas.toDataURL("image/png");
        pdf.addImage(qrImage, "PNG", pageWidth - margin - 28, y + 10, 25, 25);
      }
      pdf.save(`Braxdel_${receipt.receiptNo}.pdf`);
    }, 150);
  }

  function loadImage(src) {
    return new Promise(res => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = () => res(null);
      img.src = src;
    });
  }

  // Initial Load
  loadHistory();
</script>

</body>
</html>